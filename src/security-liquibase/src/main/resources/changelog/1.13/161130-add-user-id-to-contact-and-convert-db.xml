<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">
    <changeSet id="01" author="uladzimir.lakomy">
      <sql dbms="mysql">
          ALTER TABLE contact ADD user_id BIGINT UNSIGNED;
          SET SQL_SAFE_UPDATES=0;

          UPDATE contact,
          (
          SELECT innerTable2.contactId, COALESCE(innerTable2.userId, user.id) AS userID FROM
          (
          SELECT contactId, firstName, lastName, contactEmail, user.id AS userId, first_name, last_name  FROM
          (
          SELECT contact.id AS contactId, firstName, lastName, email.name AS contactEmail   FROM contact
          LEFT JOIN email ON email.contact_id = contact.id
          ) AS innerTable1
          LEFT JOIN user ON user.email = innerTable1.contactEmail
          ) AS innerTable2
          LEFT JOIN user ON innerTable2.firstName = user.first_name AND innerTable2.lastName = user.last_name
          ) AS mapTable
          SET contact.user_id = mapTable.userID
          WHERE contact.id = mapTable.contactId;

          SET SQL_SAFE_UPDATES=1;
      </sql>

        <rollback>
            <sql dbms="mysql">
                ALTER TABLE contact DROP COLUMN user_id;
            </sql>
        </rollback>
    </changeSet>
</databaseChangeLog>
